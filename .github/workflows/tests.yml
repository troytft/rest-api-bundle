name: Tests
on:
    push:
        branches:
            - master
    pull_request:

jobs:
    tests:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                symfony-versions: [ '5.4', '6.4' ]
                php-versions: [ '8.1', '8.3' ]

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php-versions }}
                    coverage: none
                env:
                    COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   run: echo "::add-matcher::${{ runner.tool_cache }}/php.json"
            -   run: echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

            -   name: Cache Composer packages
                id: composer-cache
                uses: actions/cache@v4
                with:
                    path: vendor
                    key: composer-vendor-cache-${{ matrix.php-versions }}-{{ matrix.symfony-versions }}-${{ hashFiles('**/composer.json') }}

            -   name: Install Symfony
                if: steps.composer-cache.outputs.cache-hit != 'true'
                run: composer require 'symfony/framework-bundle:^${{ matrix.symfony-versions }}' --no-suggest --no-interaction --no-progress

            -   name: Run PHPUnit
                run: vendor/bin/phpunit

            -   name: Run PHP Code Sniffer
                run: make test-cs

            -   name: Run PHPStan
                run: vendor/bin/phpstan analyse --no-progress
